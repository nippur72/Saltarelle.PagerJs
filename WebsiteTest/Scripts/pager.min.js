/*! pager.js - v0.7.0 - 2013-01-26
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2013 Oscar Finnsson; Licensed MIT */
(function(e){var t=e.History,n=function(n,r){"use strict";var i={};i.page=null,i.now=function(){return Date.now?Date.now():(new Date).valueOf()},i.extendWithPage=function(e){var t=new i.Page;e.$__page__=t,i.page=t},i.navigationFailed=r.observable(),i.onBindingError=n.Callbacks(),i.showChild=function(e){var t=e&&e.length===1&&e[0]===""?[]:e;i.page.showPage(t)},i.getParentPage=function(e){while(e){if(e.$page&&e.$page.val("urlToggle")!=="none")return e.$page;if(e.$data&&e.$data.$__page__)return e.$data.$__page__;e=e.$parentContext}return null};var s={};s.value=r.utils.unwrapObservable,s.arrayValue=function(e){return n.map(e,function(e){return s.value(e)})};var o=function(e){var t,n={},r=/([^&=]+)=?([^&]*)/g;while(t=r.exec(e))n[t[1]]=t[2];return n},u=function(e){if(!e)return{name:null,params:{}};var t=e.split("?"),n=t[0],r=t[1],i={};return r&&(i=o(r)),{name:n,params:i}};i.ChildManager=function(e,t){this.currentChildO=r.observable(null);var o=this;this.page=t,this.timeStamp=i.now(),this.hideChild=function(){o.currentChild&&o.currentChild.getId()!=="start"&&(o.currentChild.hidePage(function(){}),o.currentChild=null,o.currentChildO(null))},this.showChild=function(t){var r=t.length===0;this.timeStamp=i.now();var a=this.timeStamp,f=o.currentChild;o.currentChild=null;var l=!1,c=u(t[0]),h=c.name,p=null;n.each(e(),function(e,t){if(!l){var n=t.getId();if(n===h||(h===""||h==null)&&n==="start")l=!0,o.currentChild=t;n==="?"&&(p=t)}});var d=!1,v=o,m=function(e,t){if(!l){var n=t.getId(),r=t.getValue().modal;if(r){if(n===h||(h===""||h==null)&&n==="start")l=!0,o.currentChild=t,d=!0;n==="?"&&!p&&(p=t,d=!0)}}};while(!o.currentChild&&v.page.parentPage&&!v.page.getValue().modal){var g=v.page.parentPage.children;n.each(g(),m),o.currentChild||(v=v.page.parentPage.childManager)}!o.currentChild&&p&&!r&&(o.currentChild=p),o.currentChild&&(o.currentChildO(o.currentChild),d?o.currentChild.currentParentPage(o.page):o.currentChild.currentParentPage(null));var y=function(){i.navigationFailed&&i.navigationFailed({page:o.page,route:t}),o.page.getValue().navigationFailed&&s.value(o.page.getValue().navigationFailed)(o.page,t)},b=function(){var e=s.value(o.currentChild.getValue().guard);e?e(o.currentChild,t,function(){o.timeStamp===a&&o.currentChild.showPage(t.slice(1),c,t[0])},f):o.currentChild.showPage(t.slice(1),c,t[0])};f&&f===o.currentChild?b():f?f.hidePage(function(){o.currentChild?b():y()}):o.currentChild?b():y()}},i.Page=function(e,t,n,s,o){this.element=e,this.valueAccessor=t,this.allBindingsAccessor=n,this.viewModel=s,this.bindingContext=o,this.children=r.observableArray([]),this.childManager=new i.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=r.observable(null),this.isVisible=r.observable(!1),this.originalRoute=r.observable(null),this.route=null};var a=i.Page.prototype;a.val=function(e){return s.value(this.getValue()[e])},a.currentChildPage=function(){return this.childManager.currentChildO},a.showPage=function(e,t,n){var r=this,i=r.currentId,s=r.pageRoute?r.pageRoute.params:null,o=r.isVisible();r.currentId=t?t.name||"":"",r.isVisible(!0),n&&r.originalRoute(n),r.route=e,r.pageRoute=t,o?(r.getId()==="?"&&i!==r.currentId&&r.show(),t&&s!==t.params&&r.setParams()):(r.setParams(),r.show()),r.childManager.showChild(e)},a.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var e=this.pageRoute.params,t=this.ctx,i=this.val("params")||{};n.isArray(i)?n.each(i,function(n,i){var s=e[i];t[i]?t[i](s):t[i]=r.observable(s)}):n.each(i,function(n,i){var o=e[n],u;o==null?u=s.value(i):u=o,t[n]?t[n](u):t[n]=r.observable(u)})}if(this.pageRoute){var o=this.getValue().nameParam;o&&(typeof o=="string"?this.ctx[o]?this.ctx[o](this.currentId):this.ctx[o]=r.observable(this.currentId):o(this.currentId))}},a.hidePage=function(e){var t=this;"show"!==t.val("urlToggle")?(t.hideElementWrapper(e),t.childManager.hideChild()):e&&e()};var f=function(e){try{r.applyBindingsToDescendants(e.childBindingContext,e.element)}catch(t){var n=e.val("onBindingError");n&&n(e.e),i.onBindingError.fire({page:e,error:t})}};a.init=function(){var e=this,t=e.val("urlToggle"),i=r.utils.domData.get(e.element,"__ko_pagerjsBindingData");if(i)return{controlsDescendantBindings:!0};r.utils.domData.set(e.element,"__ko_pagerjsBindingData",e),r.utils.domNodeDisposal.addDisposeCallback(e.element,function(){e.parentPage&&e.parentPage.children.remove(e)});var o=e.getValue();t!=="none"&&(e.parentPage=e.getParentPage(),e.parentPage.children.push(this),e.hideElement()),e.val("source")&&e.loadSource(e.val("source")),e.ctx=null;if(o.withOnShow)e.ctx={},e.childBindingContext=e.bindingContext.createChildContext(e.ctx),r.utils.extend(e.childBindingContext,{$page:this});else{var u=o["with"]||e.bindingContext.$observableData||e.viewModel;e.ctx=s.value(u),e.augmentContext();if(r.isObservable(u)){var a=r.observable(e.ctx);e.childBindingContext=e.bindingContext.createChildContext(a),r.utils.extend(e.childBindingContext,{$page:this,$observableData:u}),f(e),u.subscribe(function(){a(s.value(u))})}else e.childBindingContext=e.bindingContext.createChildContext(e.ctx),r.utils.extend(e.childBindingContext,{$page:this,$observableData:undefined}),f(e)}if(t!=="none")e.parentPage.route&&e.parentPage.route[0]===e.getId()&&setTimeout(function(){e.parentPage.showPage(e.parentPage.route)},0);else{var l=function(){n(e.element).is(":visible")&&e.showPage([])};setTimeout(l,0),e.getParentPage().isVisible.subscribe(function(e){e&&setTimeout(l,0)})}return{controlsDescendantBindings:!0}},a.augmentContext=function(){var e=this,t=e.val("params");t&&(n.isArray(t)?n.each(t,function(t,n){e.ctx[n]||(e.ctx[n]=r.observable())}):n.each(t,function(n,i){e.ctx[n]||(r.isObservable(i)?e.ctx[n]=i:i===null?(t[n]=r.observable(null),e.ctx[n]=r.observable(null)):e.ctx[n]=r.observable(i))})),this.val("vars")&&n.each(this.val("vars"),function(t,n){r.isObservable(n)?e.ctx[t]=n:e.ctx[t]=r.observable(n)}),this.setParams()},a.getValue=function(){return this.valueAccessor?s.value(this.valueAccessor()):{}},a.getParentPage=function(){return i.getParentPage(this.bindingContext)},a.getId=function(){return this.val("id")},a.sourceUrl=function(e){var t=this;return this.getId()==="?"?r.computed(function(){var n;return t.val("deep")?n=[t.currentId].concat(t.route).join("/"):n=t.currentId,s.value(e).replace("{1}",n)}):r.computed(function(){return s.value(e)})},a.loadWithOnShow=function(){var e=this;if(!e.withOnShowLoaded||e.val("sourceCache")!==!0)e.withOnShowLoaded=!0,e.val("withOnShow")(function(t){var n=e.bindingContext.createChildContext(t);e.ctx=t,e.childBindingContext=n,e.augmentContext(),r.utils.extend(n,{$page:e}),f(e)},e)},a.loadSource=function(e){var t=this.getValue(),o=this,u=this.element,a=null,l=t.loader||i.loader;if(t.frame==="iframe"){var h=n("iframe",n(u));h.length===0&&(h=n("<iframe></iframe>"),n(u).append(h)),l&&(a=s.value(l)(o,h),a.load()),h.one("load",function(){a&&a.unload(),t.sourceLoaded&&t.sourceLoaded(o)}),r.applyBindingsToNode(h[0],{attr:{src:this.sourceUrl(e)}})}else{l&&(a=s.value(l)(o,o.element),a.load());var p=function(){a&&a.unload(),o.val("withOnShow")?o.val("withOnShow")&&o.loadWithOnShow():f(o),t.sourceLoaded&&t.sourceLoaded(o),o.route&&o.childManager.showChild(o.route)};if(typeof s.value(e)=="string"){var d=s.value(this.sourceUrl(e));c(u,d,function(){p()})}else n.each(n(u).children(),function(e,t){r.utils.domNodeDisposal.removeNode(t)}),s.value(e)(this,function(){p()})}};var l=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,c=function(e,t,i){var s,o,u,a=n(e),f=t.indexOf(" ");return f>=0&&(s=t.slice(f,t.length),t=t.slice(0,f)),jQuery.ajax({url:t,type:"GET",dataType:"html",complete:function(e,t){i&&a.each(i,u||[e.responseText,t,e])}}).done(function(e){u=arguments,n.each(a.children(),function(e,t){r.utils.domNodeDisposal.removeNode(t)}),a.html(s?jQuery("<div>").append(e.replace(l,"")).find(s):e)}),a};a.show=function(t){var n=this.element,r=this;r.showElementWrapper(t),r.val("title")&&(e.document.title=r.val("title"));if(r.val("sourceOnShow")){if(!r.val("sourceCache")||!n.__pagerLoaded__||typeof r.val("sourceCache")=="number"&&n.__pagerLoaded__+r.val("sourceCache")*1e3<i.now())n.__pagerLoaded__=i.now(),r.loadSource(r.val("sourceOnShow"))}else r.val("withOnShow")&&r.loadWithOnShow()},a.showElementWrapper=function(e){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(e),this.val("afterShow")&&this.val("afterShow")(this)},a.showElement=function(e){this.val("showElement")?this.val("showElement")(this,e):this.val("fx")?i.fx[this.val("fx")].showElement(this,e):i.showElement?i.showElement(this,e):n(this.element).show(e)},a.hideElementWrapper=function(e){this.isVisible(!1),this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(e),this.val("afterHide")&&this.val("afterHide")(this)},a.hideElement=function(e){this.val("hideElement")?this.val("hideElement")(this,e):this.val("fx")?i.fx[this.val("fx")].hideElement(this,e):i.hideElement?i.hideElement(this,e):(n(this.element).hide(),e&&e())},a.getFullRoute=function(){return this._fullRoute?this._fullRoute:(this._fullRoute=r.computed(function(){var e=null;return this.currentParentPage&&this.currentParentPage()?(e=this.currentParentPage().getFullRoute()().slice(0),e.push(this.originalRoute()||this.getId()),e):this.parentPage?(e=this.parentPage.getFullRoute()().slice(0),e.push(this.originalRoute()||this.getId()),e):[]},this),this._fullRoute)},a.nullObject=new i.Page,a.nullObject.children=r.observableArray([]),a.child=function(e){var t=this;return t._child==null&&(t._child={}),t._child[e]||(t._child[e]=r.computed(function(){var t=n.grep(this.children(),function(t){return t.getId()===e})[0];return t||this.nullObject},this)),t._child[e]},r.bindingHandlers.page={init:function(e,t,n,r,s){var o=new i.Page(e,t,n,r,s);return o.init()}},i.useHTML5history=!1,i.rootURI="/",i.Href=function(e,t,n,i,s){this.element=e,this.bindingContext=s,this.path=r.observable(),this.pageOrRelativePath=r.observable(t)};var h=i.Href.prototype;h.getParentPage=function(){return i.getParentPage(this.bindingContext)},h.init=function(){var e=this.getParentPage();this.path=r.computed(function(){var t=s.value(this.pageOrRelativePath()());if(typeof t=="string"){var n=0;while(t.substring(0,3)==="../")n++,t=t.slice(3);var r=e.getFullRoute()(),i=r.slice(0,r.length-n).join("/");return(i===""?"":i+"/")+t}return t.getFullRoute?t.getFullRoute()().join("/"):""},this)},i.Href.hash="#",h.bind=function(){var e=r.computed(function(){return i.Href.hash+this.path()},this);r.applyBindingsToNode(this.element,{attr:{href:e}})},h.update=function(e){this.pageOrRelativePath(e)},i.Href5=function(e,t,n,r,s){i.Href.apply(this,arguments)},i.Href5.prototype=new i.Href,i.Href5.history=e.history,i.Href5.prototype.bind=function(){var e=this;r.applyBindingsToNode(e.element,{attr:{href:e.path},click:function(){i.Href5.history.pushState(null,null,e.path())}})},r.bindingHandlers["page-hash"]={init:function(e,t,n,r,s){var o=new i.Href(e,t,n,r,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},r.bindingHandlers["page-href5"]={init:function(e,t,n,r,s){var o=new i.Href5(e,t,n,r,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},r.bindingHandlers["page-href"]={init:function(e,t,n,r,s){var o=i.useHTML5history?i.Href5:i.Href,u=new o(e,t,n,r,s);u.init(),u.bind(),e.__ko__page=u},update:function(e,t){e.__ko__page.update(t)}},i.fx={},i.fx.cssAsync=function(e){return{showElement:function(t,r){var i=n(t.element);i.addClass(e),i.show();var s=setInterval(function(){clearInterval(s),i.addClass(e+"-in")},10),o=setInterval(function(){clearInterval(o),r&&r()},300)},hideElement:function(t,r){var i=n(t.element);if(!t.pageHiddenOnce)t.pageHiddenOnce=!0,i.hide();else{i.removeClass(e+"-in");var s=setInterval(function(){clearInterval(s),r&&r(),i.hide()},300)}}}},i.fx.zoom=i.fx.cssAsync("pagerjs-fx-zoom"),i.fx.flip=i.fx.cssAsync("pagerjs-fx-flip"),i.fx.popout=i.fx.cssAsync("pagerjs-fx-popout-modal"),i.fx.jQuerySync=function(e,t){return{showElement:function(t,r){e.call(n(t.element),300,r)},hideElement:function(e,r){t.call(n(e.element),300,function(){n(e.element).hide()}),r&&r()}}},i.fx.slide=i.fx.jQuerySync(n.fn.slideDown,n.fn.slideUp),i.fx.fade=i.fx.jQuerySync(n.fn.fadeIn,n.fn.fadeOut);var p=function(e){return e.replace(/\+/g," ").split("/").map(decodeURIComponent)};return i.startHistoryJs=function(r){r&&t.pushState(null,null,r);var s=function(e){e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=p(e);i.showChild(t)};t.Adapter.bind(e,"statechange",function(){var e=n("base").attr("href"),r=t.getState().url.replace(e,"");s(r)}),t.Adapter.bind(e,"anchorchange",function(){s(location.hash)}),s(t.getState().url.replace(t.getRootUrl(),""))},i.startHashChange=function(t){t&&(location.hash=i.Href.hash+t),n(e).hashchange(function(){var e=location.hash;e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=p(e);i.showChild(t)}),n(e).hashchange()},i.start=function(t){t&&(location.hash=i.Href.hash+t);var r=function(e){e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=p(e);i.showChild(t)},s=function(){r(e.location.hash)};n(e).bind("hashchange",s),s()},i},r=e.define;typeof r=="function"&&typeof r.amd=="object"&&r.amd?r(["knockout","jquery"],function(e){return n($,e)}):e.pager=n($,ko)})(window);